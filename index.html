<!DOCTYPE html>
<html>
  <head>
  </head>

  <body>
    <script src="jquery-2.0.3.min.js"> </script>
    <script src="RTCMultiConnection.js"> </script>

    <style>
        video {
          width: 640px;
          height: 360px;
        }

        button {
          display: none;
        }
    </style>

    <script>
        $(document).ready(function(){
          // setup
          var connection = new RTCMultiConnection();
          var streamid = null
          var recording = false;
          var playing = false;

          // configure session
          connection.session = {
              audio: true,
              video: {
                width: 640,
                height: 360
              }
          };

          // after opening the stream show the recorder
          connection.onstream = function(e) {
            // add the recorder UI
            video = e.mediaElement;
            video.removeAttribute("controls");
            video.id = 'recorder';
            $("#players").append(video);

            // update UI
            $("#record_button").show();

            // keep track of stream ID
            streamid = e.streamid;
          };

          // open the streams
          connection.open();

          // start recording
          var startRecording = function() {
            // prepare the streams
            connection.streams[streamid].startRecording({
              audio: true,
              video: {
                width: 640,
                height: 360
              },
              canvas: {
                width: 640,
                height: 360
              }
            });

            // update the UI
            $("#play_button").hide();
            $("#recorder").show();
            $("#video-player").remove();
            $("#audio-player").remove();
            $("#record_button").text("Stop recording");

            // toggle boolean
            recording = true;
          }

          // stop recording
          var stopRecording = function() {
            // handle both players
            connection.streams[streamid].stopRecording(function (blob) {
              // add player
              var element = document.createElement(blob.recordingType);
              element.id = blob.recordingType + "-player";
              element.src = URL.createObjectURL(blob);
            });

            // update UI
            $("#recorder").hide();
            $("#players").append(element);
            $("#play_button").show();
            $("#record_button").text("Start recording");

            // toggle boolean
            recording = false;
          }

          // handle recording
          $("#record_button").click(function(){
            if (recording) {
              stopRecording();
            } else {
              startRecording();
            }
          });

          // stop playback
          var stopPlayback = function() {
            // controlling
            video = $("#video-player")[0];
            video.pause();
            video.currentTime = 0;
            audio = $("#audio-player")[0];
            audio.pause();
            audio.currentTime = 0;

            // update ui
            $("#play_button").text("Play");

            // toggle boolean
            playing = false;
          }

          // start playback
          var startPlayback = function() {
            // video controlling
            video = $("#video-player")[0];
            video.play();
            audio = $("#audio-player")[0];
            audio.play();
            $("#video-player").bind("ended", stopPlayback);

            // Update UI
            $("#play_button").text("Stop");

            // toggle boolean
            playing = true;
          }

          // handle playback
          $("#play_button").click(function(){
            if (playing) {
              stopPlayback();
            } else {
              startPlayback();
            }
          });


        });
    </script>

  </body>

  <div id='players'></div>
  <button id='record_button'>Start recording</button>
  <button id='play_button'>Play</button>

</html>